<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>形成-DB 鉄道編成表</title>
    <style>
        :root { --car-width: 160px; --bg-color: #f5f5f5; }
        body { font-family: sans-serif; background: var(--bg-color); margin: 0; padding: 20px; }
        .formation-group { background: white; border-radius: 8px; padding: 20px; margin-bottom: 40px; overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .formation-title { font-weight: bold; font-size: 1.2rem; border-left: 5px solid #333; padding-left: 10px; margin-bottom: 50px; }
        .car-list { display: flex; align-items: flex-end; gap: 0; min-width: max-content; }
        
        .car-container { position: relative; width: var(--car-width); flex-shrink: 0; margin-right: 80px; }
        .car-main-img { width: 100%; display: block; position: relative; z-index: 2; }
        
        /* パンタグラフ配置 */
        .panta { position: absolute; top: -15px; width: 35px; z-index: 3; }
        .panta-left { left: 15px; }
        .panta-right { right: 15px; }
        
        /* 台車配置 */
        .bogie { position: absolute; bottom: -8px; width: 45px; z-index: 1; }
        .bogie-left { left: 20px; }
        .bogie-right { right: 20px; }

        /* 方向表示 (1号車と最後尾のみ) */
        .direction { position: absolute; top: -45px; font-size: 11px; font-weight: bold; color: #555; width: 100%; }
        .dir-left { text-align: left; left: 0; }
        .dir-right { text-align: right; right: 0; }

        /* 右横の情報エリア */
        .side-info { position: absolute; left: 105%; top: 0; display: flex; flex-direction: column; gap: 4px; font-size: 11px; width: 150px; }
        .stamp-row { display: flex; align-items: center; gap: 4px; }
        .stamp-icon { width: 18px; height: 18px; object-fit: contain; }

        /* 車歴エリア */
        .history-box { margin-top: 15px; font-size: 10px; border-top: 1px dashed #ccc; padding-top: 5px; }
        .history-item { margin-bottom: 5px; }
        .car-id { text-align: center; margin-top: 10px; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<div id="formation-viewer">読み込み中...</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
const CSV_URL = 'data.csv'; // アップロードしたファイル名
const PANTA_MAP = { '◇': 'p0', '＜': 'p1', '＞': 'p2', '<': 'py1', '>': 'py2' };

function getRyaku(carNo) {
    // 簡易的な略号変換ロジック (クハE130-801 -> Tc'801風)
    if (!carNo) return "";
    let parts = carNo.split('-');
    let type = parts[0];
    let num = parts[parts.length - 1];
    let prefix = "";
    
    if (type.includes("クハ")) prefix = "Tc";
    else if (type.includes("クモハ")) prefix = "Mc";
    else if (type.includes("モハ")) prefix = "M";
    else if (type.includes("サハ")) prefix = "T";
    
    // 形式番号の数字部分が偶数ならダッシュをつける簡易判定（E130等）
    if (type.match(/E\d*[02468]/)) prefix += "'";
    
    return prefix + num;
}

Papa.parse(CSV_URL, {
    download: true,
    header: true,
    complete: function(results) {
        const data = results.data;
        const container = document.getElementById('formation-viewer');
        container.innerHTML = '';

        // 編成ごとにグループ化
        const formations = {};
        data.forEach(row => {
            if (!row.編成名) return;
            if (!formations[row.編成名]) formations[row.編成名] = [];
            formations[row.編成名].push(row);
        });

        for (const fName in formations) {
            const fRows = formations[fName].sort((a, b) => a.号車 - b.号車);
            let fHtml = `<div class="formation-group">
                <div class="formation-title">${fRows[0].路線系統} ${fName}</div>
                <div class="car-list">`;

            fRows.forEach((row, index) => {
                const isFirst = index === 0;
                const isLast = index === fRows.length - 1;
                const ryaku = row.略号 || getRyaku(row.車両番号);

                fHtml += `
                <div class="car-container">
                    ${isFirst ? `<div class="direction dir-left">◀︎${row.左方向}</div>` : ''}
                    ${isLast ? `<div class="direction dir-right">${row.右方向}▶︎</div>` : ''}

                    ${row.左パンタ ? `<img src="images/${PANTA_MAP[row.左パンタ]}.png" class="panta panta-left">` : ''}
                    ${row.右パンタ ? `<img src="images/${PANTA_MAP[row.右パンタ]}.png" class="panta panta-right">` : ''}

                    <img src="images/${row.車体アイコン}.png" class="car-main-img">

                    ${row.左台車 ? `<img src="images/${row.左台車}.png" class="bogie bogie-left">` : ''}
                    ${row.右台車 ? `<img src="images/${row.右台車}.png" class="bogie bogie-right">` : ''}

                    <div class="car-id">${ryaku}</div>

                    <div class="side-info">
                        <div class="stamp-row">
                            ${row["車両情報(選択)"] ? `<img src="images/${row["車両情報(選択)"]}.png" class="stamp-icon">` : ''}
                            <span>${row["車両情報(記述)"] || ''}</span>
                        </div>
                        <div>${row.製造所 || ''}</div>
                        <div>${row.落成日 || ''}落成</div>
                    </div>

                    <div class="history-box">
                        ${row["車歴1(日付)"] ? `<div class="history-item"><b>${row["車歴1(日付)"]}</b><br>${row["車歴1(記述)"]}</div>` : ''}
                    </div>
                </div>`;
            });

            fHtml += `</div></div>`;
            container.innerHTML += fHtml;
        }
    }
});
</script>
</body>
</html>
