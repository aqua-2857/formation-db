<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>鉄道車両管理システム - Advanced Timeline</title>
    <style>
        :root { --header-bg: #1c1c1c; --main-bg: #f0f0f0; --text-main: #333; }
        body { font-family: sans-serif; background: var(--main-bg); margin: 0; color: var(--text-main); }
        .header { background: var(--header-bg); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; }
        .period-display { font-size: 0.9rem; color: #aaa; margin-top: 5px; display: block; }
        .section-title { font-size: 16px; font-weight: bold; margin: 25px 0 10px 0; border-left: 5px solid #333; padding-left: 10px; }
        .history-item { background: white; margin-bottom: 10px; padding: 12px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .history-date { font-weight: bold; color: #555; font-size: 0.85rem; }
        .history-desc { margin-top: 5px; line-height: 1.4; }
        .car-tag { display: inline-block; background: #e0e0e0; color: #444; font-size: 0.75rem; padding: 2px 6px; border-radius: 3px; margin-left: 5px; font-weight: bold; }
        .hidden { display: none; }
        .formation-card { background: white; margin: 10px; padding: 15px; border-radius: 8px; cursor: pointer; border: 1px solid #ddd; }
    </small></style>
</head>
<body>

<div id="home-view">
    <div class="header">編成一覧</div>
    <div id="formation-list"></div>
</div>

<div id="detail-view" class="hidden">
    <div class="header">
        <div onclick="showHome()" style="cursor:pointer; display:inline-block; margin-right:10px;">◀</div>
        <span id="detail-title" style="font-weight:bold;"></span>
        <span id="detail-period" class="period-display"></span>
    </div>
    
    <div style="padding: 15px;">
        <div class="section-title">編成・車両 統合履歴</div>
        <div id="history-container"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
let formations = [];
let histories = [];
let carIds = [];

// スプレッドシート由来のファイル名をそのまま指定
const FILES = {
    formation: 'data - 編成表.csv',
    history: 'data - 車歴表.csv',
    car: 'data - 車両ID.csv'
};

function loadCSV(url) {
    return new Promise(resolve => {
        Papa.parse(url, {
            download: true, header: true, skipEmptyLines: true,
            complete: results => resolve(results.data)
        });
    });
}

// データの読み込み
Promise.all([
    loadCSV(FILES.formation),
    loadCSV(FILES.history),
    loadCSV(FILES.car)
]).then(results => {
    formations = results[0];
    histories = results[1];
    carIds = results[2];
    renderList();
});

function renderList() {
    const list = document.getElementById('formation-list');
    formations.forEach(f => {
        const card = document.createElement('div');
        card.className = 'formation-card';
        card.innerHTML = `
            <div style="font-weight:bold;">${f.編成名}</div>
            <div style="font-size:0.8rem; color:#666;">期間: ${f.始} ～ ${f.終 || '現在'}</div>
        `;
        card.onclick = () => showDetail(f);
        list.appendChild(card);
    });
}

function showDetail(f) {
    document.getElementById('home-view').classList.add('hidden');
    document.getElementById('detail-view').classList.remove('hidden');
    
    document.getElementById('detail-title').innerText = f.編成名;
    // 「始」〜「終」を詳細画面に表示
    document.getElementById('detail-period').innerText = `運用期間：${f.始} ～ ${f.終 || '現在'}`;

    const container = document.getElementById('history-container');
    container.innerHTML = '';

    // 現在の編成に含まれるIDを最大12両分取得
    const currentFormationIDs = [];
    for (let i = 1; i <= 12; i++) {
        const id = f[`車両ID${i}`];
        if (id && id.trim()) currentFormationIDs.push(id.trim());
    }

    // 車歴表からこの編成に関わるイベントを抽出
    const filteredEvents = histories.filter(h => {
        for (let i = 1; i <= 12; i++) {
            if (currentFormationIDs.includes(h[`車両ID${i}`])) return true;
        }
        return false;
    });

    // 日付順に並べ替え
    filteredEvents.sort((a, b) => new Date(a.日付) - new Date(b.日付));

    filteredEvents.forEach(ev => {
        // イベントに関わっている車両のうち、現在表示中の編成に属するものを特定
        const affectedCars = [];
        for (let i = 1; i <= 12; i++) {
            const idInEv = ev[`車両ID${i}`];
            if (currentFormationIDs.includes(idInEv)) {
                // 車両IDシートから番号を引く
                const master = carIds.find(c => c.車両ID === idInEv);
                affectedCars.push(master ? master.車両番号 : idInEv);
            }
        }

        const isAll = affectedCars.length === currentFormationIDs.length;
        const carTags = isAll ? "" : affectedCars.map(no => `<span class="car-tag">${no}</span>`).join('');

        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
            <div class="history-date">${ev.日付}</div>
            <div class="history-desc">${ev.記述}${carTags}</div>
        `;
        container.appendChild(item);
    });
}

function showHome() {
    document.getElementById('home-view').classList.remove('hidden');
    document.getElementById('detail-view').classList.add('hidden');
}
</script>
</body>
</html>
